(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{367:function(n,s,e){"use strict";e.r(s);var a=e(25),t=Object(a.a)({},(function(){var n=this,s=n.$createElement,e=n._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[e("p"),e("div",{staticClass:"table-of-contents"},[e("ul",[e("li",[e("a",{attrs:{href:"#由gevent社区编写"}},[n._v("由Gevent社区编写")])])])]),e("p"),n._v(" "),e("h3",{attrs:{id:"由gevent社区编写"}},[n._v("由Gevent社区编写")]),n._v(" "),e("blockquote",[e("p",[n._v("gevent是一个基于"),e("a",{attrs:{href:"http://software.schmorp.de/pkg/libev.html",target:"_blank",rel:"noopener noreferrer"}},[n._v("libev"),e("OutboundLink")],1),n._v("的并发库。它为各种并发和网络相关的任务提供了整洁的API。")])]),n._v(" "),e("h1",{attrs:{id:"介绍"}},[n._v("介绍")]),n._v(" "),e("p",[n._v("本指南假定读者有中级Python水平，但不要求有其它更多的知识，不期待读者有 并发方面的知识。本指南的目标在于给予你需要的工具来开始使用gevent，帮助你 驯服现有的并发问题，并从今开始编写异步应用程序。")]),n._v(" "),e("h3",{attrs:{id:"贡献者"}},[n._v("贡献者")]),n._v(" "),e("p",[n._v("按提供贡献的时间先后顺序列出如下: "),e("a",{attrs:{href:"http://www.stephendiehl.com",target:"_blank",rel:"noopener noreferrer"}},[n._v("Stephen Diehl"),e("OutboundLink")],1),n._v(" "),e("a",{attrs:{href:"https://github.com/jerem",target:"_blank",rel:"noopener noreferrer"}},[n._v("Jérémy Bethmont"),e("OutboundLink")],1),n._v(" "),e("a",{attrs:{href:"https://github.com/sww",target:"_blank",rel:"noopener noreferrer"}},[n._v("sww"),e("OutboundLink")],1),n._v(" "),e("a",{attrs:{href:"https://github.com/brunoqc",target:"_blank",rel:"noopener noreferrer"}},[n._v("Bruno Bigras"),e("OutboundLink")],1),n._v(" "),e("a",{attrs:{href:"https://github.com/dripton",target:"_blank",rel:"noopener noreferrer"}},[n._v("David Ripton"),e("OutboundLink")],1),n._v(" "),e("a",{attrs:{href:"https://github.com/traviscline",target:"_blank",rel:"noopener noreferrer"}},[n._v("Travis Cline"),e("OutboundLink")],1),n._v(" "),e("a",{attrs:{href:"https://github.com/Lothiraldan",target:"_blank",rel:"noopener noreferrer"}},[n._v("Boris Feld"),e("OutboundLink")],1),n._v(" "),e("a",{attrs:{href:"https://github.com/youngsterxyf",target:"_blank",rel:"noopener noreferrer"}},[n._v("youngsterxyf"),e("OutboundLink")],1),n._v(" "),e("a",{attrs:{href:"https://github.com/ehebert",target:"_blank",rel:"noopener noreferrer"}},[n._v("Eddie Hebert"),e("OutboundLink")],1),n._v(" "),e("a",{attrs:{href:"http://notmyidea.org",target:"_blank",rel:"noopener noreferrer"}},[n._v("Alexis Metaireau"),e("OutboundLink")],1),n._v(" "),e("a",{attrs:{href:"https://github.com/djv",target:"_blank",rel:"noopener noreferrer"}},[n._v("Daniel Velkov"),e("OutboundLink")],1)]),n._v(" "),e("p",[n._v("同时感谢Denis Bilenko写了gevent和相应的指导以形成本指南。")]),n._v(" "),e("p",[n._v("这是一个以MIT许可证发布的协作文档。你想添加一些内容？或看见一个排版错误？ Fork一个分支发布一个request到 "),e("a",{attrs:{href:"https://github.com/sdiehl/gevent-tutorial",target:"_blank",rel:"noopener noreferrer"}},[n._v("Github"),e("OutboundLink")],1),n._v(". 我们欢迎任何贡献。")]),n._v(" "),e("p",[n._v("本页也有"),e("a",{attrs:{href:"http://methane.github.com/gevent-tutorial-ja",target:"_blank",rel:"noopener noreferrer"}},[n._v("日文版本"),e("OutboundLink")],1),n._v("。")]),n._v(" "),e("h1",{attrs:{id:"核心部分"}},[n._v("核心部分")]),n._v(" "),e("h2",{attrs:{id:"greenlets"}},[n._v("Greenlets")]),n._v(" "),e("p",[n._v("在gevent中用到的主要模式是"),e("strong",[n._v("Greenlet")]),n._v(", 它是以C扩展模块形式接入Python的轻量级协程。 Greenlet全部运行在主程序操作系统进程的内部，但它们被协作式地调度。")]),n._v(" "),e("blockquote",[e("p",[n._v("在任何时刻，只有一个协程在运行。")])]),n._v(" "),e("p",[n._v("这与"),e("code",[n._v("multiprocessing")]),n._v("或"),e("code",[n._v("threading")]),n._v("等提供真正并行构造的库是不同的。 这些库轮转使用操作系统调度的进程和线程，是真正的并行。")]),n._v(" "),e("h2",{attrs:{id:"同步和异步执行"}},[n._v("同步和异步执行")]),n._v(" "),e("p",[n._v("并发的核心思想在于，大的任务可以分解成一系列的子任务，后者可以被调度成 同时执行或 "),e("em",[n._v("异步")]),n._v("执行，而不是一次一个地或者"),e("em",[n._v("同步")]),n._v("地执行。两个子任务之间的 切换也就是 "),e("em",[n._v("上下文切换")]),n._v("。")]),n._v(" "),e("p",[n._v("在gevent里面，上下文切换是通过"),e("em",[n._v("yielding")]),n._v("来完成的. 在下面的例子里， 我们有两个上下文，通过调用 "),e("code",[n._v("gevent.sleep(0)")]),n._v("，它们各自yield向对方。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport gevent\n\ndef foo():\n    print('Running in foo')\n    gevent.sleep(0)\n    print('Explicit context switch to foo again')\n\ndef bar():\n    print('Explicit context to bar')\n    gevent.sleep(0)\n    print('Implicit context switch back to bar')\n\ngevent.joinall([\n    gevent.spawn(foo),\n    gevent.spawn(bar),\n])\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nRunning in foo\nExplicit context to bar\nExplicit context switch to foo again\nImplicit context switch back to bar\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br")])]),e("p",[n._v("下图将控制流形象化，就像在调试器中单步执行整个程序，以说明上下文切换如何发生。")]),n._v(" "),e("p",[e("img",{attrs:{src:"http://hhkbp2.com/gevent-tutorial/flow.gif",alt:"Greenlet Control Flow"}})]),n._v(" "),e("p",[n._v("当我们在受限于网络或IO的函数中使用gevent，这些函数会被协作式的调度， gevent的真正能力会得到发挥。Gevent处理了所有的细节， 来保证你的网络库会在可能的时候，隐式交出greenlet上下文的执行权。 这样的一种用法是如何强大，怎么强调都不为过。或者我们举些例子来详述。")]),n._v(" "),e("p",[n._v("下面例子中的"),e("code",[n._v("select()")]),n._v("函数通常是一个在各种文件描述符上轮询的阻塞调用。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport time\nimport gevent\nfrom gevent import select\n\nstart = time.time()\ntic = lambda: 'at %1.1f seconds' % (time.time() - start)\n\ndef gr1():\n    # Busy waits for a second, but we don't want to stick around...\n    print('Started Polling: %s' % tic())\n    select.select([], [], [], 2)\n    print('Ended Polling: %s' % tic())\n\ndef gr2():\n    # Busy waits for a second, but we don't want to stick around...\n    print('Started Polling: %s' % tic())\n    select.select([], [], [], 2)\n    print('Ended Polling: %s' % tic())\n\ndef gr3():\n    print(\"Hey lets do some stuff while the greenlets poll, %s\" % tic())\n    gevent.sleep(1)\n\ngevent.joinall([\n    gevent.spawn(gr1),\n    gevent.spawn(gr2),\n    gevent.spawn(gr3),\n])\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nStarted Polling: at 0.0 seconds\nStarted Polling: at 0.0 seconds\nHey lets do some stuff while the greenlets poll, at 0.0 seconds\nEnded Polling: at 2.0 seconds\nEnded Polling: at 2.0 seconds\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br")])]),e("p",[n._v("下面是另外一个多少有点人造色彩的例子，定义一个"),e("em",[n._v("非确定性的(non-deterministic)")]),n._v(" 的 "),e("code",[n._v("task")]),n._v("函数(给定相同输入的情况下，它的输出不保证相同)。 此例中执行这个函数的副作用就是，每次task在它的执行过程中都会随机地停某些秒。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport gevent\nimport random\n\ndef task(pid):\n    \"\"\"\n    Some non-deterministic task\n    \"\"\"\n    gevent.sleep(random.randint(0,2)*0.001)\n    print('Task %s done' % pid)\n\ndef synchronous():\n    for i in range(1,10):\n        task(i)\n\ndef asynchronous():\n    threads = [gevent.spawn(task, i) for i in xrange(10)]\n    gevent.joinall(threads)\n\nprint('Synchronous:')\nsynchronous()\n\nprint('Asynchronous:')\nasynchronous()\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nSynchronous:\nTask 1 done\nTask 2 done\nTask 3 done\nTask 4 done\nTask 5 done\nTask 6 done\nTask 7 done\nTask 8 done\nTask 9 done\nAsynchronous:\nTask 3 done\nTask 7 done\nTask 9 done\nTask 2 done\nTask 4 done\nTask 1 done\nTask 8 done\nTask 6 done\nTask 0 done\nTask 5 done\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br")])]),e("p",[n._v("上例中，在同步的部分，所有的task都同步的执行， 结果当每个task在执行时主流程被 "),e("em",[n._v("阻塞")]),n._v("(主流程的执行暂时停住)。")]),n._v(" "),e("p",[n._v("程序的重要部分是将task函数封装到Greenlet内部线程的"),e("code",[n._v("gevent.spawn")]),n._v("。 初始化的greenlet列表存放在数组 "),e("code",[n._v("threads")]),n._v("中，此数组被传给"),e("code",[n._v("gevent.joinall")]),n._v(" 函数，后者阻塞当前流程，并执行所有给定的greenlet。执行流程只会在 所有greenlet执行完后才会继续向下走。")]),n._v(" "),e("p",[n._v("要重点留意的是，异步的部分本质上是随机的，而且异步部分的整体运行时间比同步 要大大减少。事实上，同步部分的最大运行时间，即是每个task停0.002秒，结果整个 队列要停0.02秒。而异步部分的最大运行时间大致为0.002秒，因为没有任何一个task会 阻塞其它task的执行。")]),n._v(" "),e("p",[n._v("一个更常见的应用场景，如异步地向服务器取数据，取数据操作的执行时间 依赖于发起取数据请求时远端服务器的负载，各个请求的执行时间会有差别。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("import gevent.monkey\ngevent.monkey.patch_socket()\n\nimport gevent\nimport urllib2\nimport simplejson as json\n\ndef fetch(pid):\n    response = urllib2.urlopen('http://json-time.appspot.com/time.json')\n    result = response.read()\n    json_result = json.loads(result)\n    datetime = json_result['datetime']\n\n    print('Process %s: %s' % (pid, datetime))\n    return json_result['datetime']\n\ndef synchronous():\n    for i in range(1,10):\n        fetch(i)\n\ndef asynchronous():\n    threads = []\n    for i in range(1,10):\n        threads.append(gevent.spawn(fetch, i))\n    gevent.joinall(threads)\n\nprint('Synchronous:')\nsynchronous()\n\nprint('Asynchronous:')\nasynchronous()\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br"),e("span",{staticClass:"line-number"},[n._v("32")]),e("br")])]),e("h2",{attrs:{id:"确定性"}},[n._v("确定性")]),n._v(" "),e("p",[n._v("就像之前所提到的，greenlet具有确定性。在相同配置相同输入的情况下，它们总是 会产生相同的输出。下面就有例子，我们在multiprocessing的pool之间执行一系列的 任务，与在gevent的pool之间执行作比较。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport time\n\ndef echo(i):\n    time.sleep(0.001)\n    return i\n\n# Non Deterministic Process Pool\n\nfrom multiprocessing.pool import Pool\n\np = Pool(10)\nrun1 = [a for a in p.imap_unordered(echo, xrange(10))]\nrun2 = [a for a in p.imap_unordered(echo, xrange(10))]\nrun3 = [a for a in p.imap_unordered(echo, xrange(10))]\nrun4 = [a for a in p.imap_unordered(echo, xrange(10))]\n\nprint(run1 == run2 == run3 == run4)\n\n# Deterministic Gevent Pool\n\nfrom gevent.pool import Pool\n\np = Pool(10)\nrun1 = [a for a in p.imap_unordered(echo, xrange(10))]\nrun2 = [a for a in p.imap_unordered(echo, xrange(10))]\nrun3 = [a for a in p.imap_unordered(echo, xrange(10))]\nrun4 = [a for a in p.imap_unordered(echo, xrange(10))]\n\nprint(run1 == run2 == run3 == run4)\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("False\nTrue\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br")])]),e("p",[n._v("即使gevent通常带有确定性，当开始与如socket或文件等外部服务交互时， 不确定性也可能溜进你的程序中。因此尽管gevent线程是一种“确定的并发”形式， 使用它仍然可能会遇到像使用POSIX线程或进程时遇到的那些问题。")]),n._v(" "),e("p",[n._v("涉及并发长期存在的问题就是"),e("em",[n._v("竞争条件(race condition)")]),n._v("。简单来说， 当两个并发线程/进程都依赖于某个共享资源同时都尝试去修改它的时候， 就会出现竞争条件。这会导致资源修改的结果状态依赖于时间和执行顺序。 这是个问题，我们一般会做很多努力尝试避免竞争条件， 因为它会导致整个程序行为变得不确定。")]),n._v(" "),e("p",[n._v("最好的办法是始终避免所有全局的状态。全局状态和导入时(import-time)副作用总是会 反咬你一口！")]),n._v(" "),e("h2",{attrs:{id:"创建greenlets"}},[n._v("创建Greenlets")]),n._v(" "),e("p",[n._v("gevent对Greenlet初始化提供了一些封装，最常用的使用模板之一有")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('\nimport gevent\nfrom gevent import Greenlet\n\ndef foo(message, n):\n    """\n    Each thread will be passed the message, and n arguments\n    in its initialization.\n    """\n    gevent.sleep(n)\n    print(message)\n\n# Initialize a new Greenlet instance running the named function\n# foo\nthread1 = Greenlet.spawn(foo, "Hello", 1)\n\n# Wrapper for creating and running a new Greenlet from the named\n# function foo, with the passed arguments\nthread2 = gevent.spawn(foo, "I live!", 2)\n\n# Lambda expressions\nthread3 = gevent.spawn(lambda x: (x+1), 2)\n\nthreads = [thread1, thread2, thread3]\n\n# Block until all threads complete.\ngevent.joinall(threads)\n\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nHello\nI live!\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br")])]),e("p",[n._v("除使用基本的Greenlet类之外，你也可以子类化Greenlet类，重载它的"),e("code",[n._v("_run")]),n._v("方法。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('\nimport gevent\nfrom gevent import Greenlet\n\nclass MyGreenlet(Greenlet):\n\n    def __init__(self, message, n):\n        Greenlet.__init__(self)\n        self.message = message\n        self.n = n\n\n    def _run(self):\n        print(self.message)\n        gevent.sleep(self.n)\n\ng = MyGreenlet("Hi there!", 3)\ng.start()\ng.join()\n\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nHi there!\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br")])]),e("h2",{attrs:{id:"greenlet状态"}},[n._v("Greenlet状态")]),n._v(" "),e("p",[n._v("就像任何其他成段代码，Greenlet也可能以不同的方式运行失败。 Greenlet可能未能成功抛出异常，不能停止运行，或消耗了太多的系统资源。")]),n._v(" "),e("p",[n._v("一个greenlet的状态通常是一个依赖于时间的参数。在greenlet中有一些标志， 让你可以监视它的线程内部状态：")]),n._v(" "),e("ul",[e("li",[e("code",[n._v("started")]),n._v(" -- Boolean, 指示此Greenlet是否已经启动")]),n._v(" "),e("li",[e("code",[n._v("ready()")]),n._v(" -- Boolean, 指示此Greenlet是否已经停止")]),n._v(" "),e("li",[e("code",[n._v("successful()")]),n._v(" -- Boolean, 指示此Greenlet是否已经停止而且没抛异常")]),n._v(" "),e("li",[e("code",[n._v("value")]),n._v(" -- 任意值, 此Greenlet代码返回的值")]),n._v(" "),e("li",[e("code",[n._v("exception")]),n._v(" -- 异常, 此Greenlet内抛出的未捕获异常")])]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport gevent\n\ndef win():\n    return 'You win!'\n\ndef fail():\n    raise Exception('You fail at failing.')\n\nwinner = gevent.spawn(win)\nloser = gevent.spawn(fail)\n\nprint(winner.started) # True\nprint(loser.started)  # True\n\n# Exceptions raised in the Greenlet, stay inside the Greenlet.\ntry:\n    gevent.joinall([winner, loser])\nexcept Exception as e:\n    print('This will never be reached')\n\nprint(winner.value) # 'You win!'\nprint(loser.value)  # None\n\nprint(winner.ready()) # True\nprint(loser.ready())  # True\n\nprint(winner.successful()) # True\nprint(loser.successful())  # False\n\n# The exception raised in fail, will not propogate outside the\n# greenlet. A stack trace will be printed to stdout but it\n# will not unwind the stack of the parent.\n\nprint(loser.exception)\n\n# It is possible though to raise the exception again outside\n# raise loser.exception\n# or with\n# loser.get()\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br"),e("span",{staticClass:"line-number"},[n._v("32")]),e("br"),e("span",{staticClass:"line-number"},[n._v("33")]),e("br"),e("span",{staticClass:"line-number"},[n._v("34")]),e("br"),e("span",{staticClass:"line-number"},[n._v("35")]),e("br"),e("span",{staticClass:"line-number"},[n._v("36")]),e("br"),e("span",{staticClass:"line-number"},[n._v("37")]),e("br"),e("span",{staticClass:"line-number"},[n._v("38")]),e("br"),e("span",{staticClass:"line-number"},[n._v("39")]),e("br"),e("span",{staticClass:"line-number"},[n._v("40")]),e("br"),e("span",{staticClass:"line-number"},[n._v("41")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nTrue\nTrue\nYou win!\nNone\nTrue\nTrue\nTrue\nFalse\nYou fail at failing.\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br")])]),e("h2",{attrs:{id:"程序停止"}},[n._v("程序停止")]),n._v(" "),e("p",[n._v("当主程序(main program)收到一个SIGQUIT信号时，不能成功做yield操作的 Greenlet可能会令意外地挂起程序的执行。这导致了所谓的僵尸进程， 它需要在Python解释器之外被kill掉。")]),n._v(" "),e("p",[n._v("对此，一个通用的处理模式就是在主程序中监听SIGQUIT信号，在程序退出 调用 "),e("code",[n._v("gevent.shutdown")]),n._v("。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("import gevent\nimport signal\n\ndef run_forever():\n    gevent.sleep(1000)\n\nif __name__ == '__main__':\n    gevent.signal(signal.SIGQUIT, gevent.shutdown)\n    thread = gevent.spawn(run_forever)\n    thread.join()\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br")])]),e("h2",{attrs:{id:"超时"}},[n._v("超时")]),n._v(" "),e("p",[n._v("超时是一种对一块代码或一个Greenlet的运行时间的约束。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport gevent\nfrom gevent import Timeout\n\nseconds = 10\n\ntimeout = Timeout(seconds)\ntimeout.start()\n\ndef wait():\n    gevent.sleep(10)\n\ntry:\n    gevent.spawn(wait).join()\nexcept Timeout:\n    print('Could not complete')\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br")])]),e("p",[n._v("超时类也可以用在上下文管理器(context manager)中, 也就是with语句内。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("import gevent\nfrom gevent import Timeout\n\ntime_to_wait = 5 # seconds\n\nclass TooLong(Exception):\n    pass\n\nwith Timeout(time_to_wait, TooLong):\n    gevent.sleep(10)\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br")])]),e("p",[n._v("另外，对各种Greenlet和数据结构相关的调用，gevent也提供了超时参数。 例如：")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport gevent\nfrom gevent import Timeout\n\ndef wait():\n    gevent.sleep(2)\n\ntimer = Timeout(1).start()\nthread1 = gevent.spawn(wait)\n\ntry:\n    thread1.join(timeout=timer)\nexcept Timeout:\n    print('Thread 1 timed out')\n\n# --\n\ntimer = Timeout.start_new(1)\nthread2 = gevent.spawn(wait)\n\ntry:\n    thread2.get(timeout=timer)\nexcept Timeout:\n    print('Thread 2 timed out')\n\n# --\n\ntry:\n    gevent.with_timeout(1, wait)\nexcept Timeout:\n    print('Thread 3 timed out')\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br"),e("span",{staticClass:"line-number"},[n._v("32")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nThread 1 timed out\nThread 2 timed out\nThread 3 timed out\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br")])]),e("h2",{attrs:{id:"猴子补丁-monkey-patching"}},[n._v("猴子补丁(Monkey patching)")]),n._v(" "),e("p",[n._v("我们现在来到gevent的死角了. 在此之前，我已经避免提到猴子补丁(monkey patching) 以尝试使gevent这个强大的协程模型变得生动有趣，但现在到了讨论猴子补丁的黑色艺术 的时候了。你之前可能注意到我们提到了 "),e("code",[n._v("monkey.patch_socket()")]),n._v("这个命令，这个 纯粹副作用命令是用来改变标准socket库的。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('import socket\nprint(socket.socket)\n\nprint("After monkey patch")\nfrom gevent import monkey\nmonkey.patch_socket()\nprint(socket.socket)\n\nimport select\nprint(select.select)\nmonkey.patch_select()\nprint("After monkey patch")\nprint(select.select)\n\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("class 'socket.socket'\nAfter monkey patch\nclass 'gevent.socket.socket'\n\nbuilt-in function select\nAfter monkey patch\nfunction select at 0x1924de8\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br")])]),e("p",[n._v("Python的运行环境允许我们在运行时修改大部分的对象，包括模块，类甚至函数。 这是个一般说来令人惊奇的坏主意，因为它创造了“隐式的副作用”，如果出现问题 它很多时候是极难调试的。虽然如此，在极端情况下当一个库需要修改Python本身 的基础行为的时候，猴子补丁就派上用场了。在这种情况下，gevent能够 修改标准库里面大部分的阻塞式系统调用，包括 "),e("code",[n._v("socket")]),n._v("、"),e("code",[n._v("ssl")]),n._v("、"),e("code",[n._v("threading")]),n._v("和 "),e("code",[n._v("select")]),n._v("等模块，而变为协作式运行。")]),n._v(" "),e("p",[n._v("例如，Redis的python绑定一般使用常规的tcp socket来与"),e("code",[n._v("redis-server")]),n._v("实例通信。 通过简单地调用 "),e("code",[n._v("gevent.monkey.patch_all()")]),n._v("，可以使得redis的绑定协作式的调度 请求，与gevent栈的其它部分一起工作。")]),n._v(" "),e("p",[n._v("这让我们可以将一般不能与gevent共同工作的库结合起来，而不用写哪怕一行代码。 虽然猴子补丁仍然是邪恶的(evil)，但在这种情况下它是“有用的邪恶(useful evil)”。")]),n._v(" "),e("h1",{attrs:{id:"数据结构"}},[n._v("数据结构")]),n._v(" "),e("h2",{attrs:{id:"事件"}},[n._v("事件")]),n._v(" "),e("p",[n._v("事件(event)是一个在Greenlet之间异步通信的形式。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("import gevent\nfrom gevent.event import Event\n\n'''\nIllustrates the use of events\n'''\n\nevt = Event()\n\ndef setter():\n    '''After 3 seconds, wake all threads waiting on the value of evt'''\n    print('A: Hey wait for me, I have to do something')\n    gevent.sleep(3)\n    print(\"Ok, I'm done\")\n    evt.set()\n\ndef waiter():\n    '''After 3 seconds the get call will unblock'''\n    print(\"I'll wait for you\")\n    evt.wait()  # blocking\n    print(\"It's about time\")\n\ndef main():\n    gevent.joinall([\n        gevent.spawn(setter),\n        gevent.spawn(waiter),\n        gevent.spawn(waiter),\n        gevent.spawn(waiter),\n        gevent.spawn(waiter),\n        gevent.spawn(waiter)\n    ])\n\nif __name__ == '__main__': main()\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br"),e("span",{staticClass:"line-number"},[n._v("32")]),e("br"),e("span",{staticClass:"line-number"},[n._v("33")]),e("br"),e("span",{staticClass:"line-number"},[n._v("34")]),e("br")])]),e("p",[n._v("事件对象的一个扩展是AsyncResult，它允许你在唤醒调用上附加一个值。 它有时也被称作是future或defered，因为它持有一个指向将来任意时间可设置 为任何值的引用。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('import gevent\nfrom gevent.event import AsyncResult\na = AsyncResult()\n\ndef setter():\n    """\n    After 3 seconds set the result of a.\n    """\n    gevent.sleep(3)\n    a.set(\'Hello!\')\n\ndef waiter():\n    """\n    After 3 seconds the get call will unblock after the setter\n    puts a value into the AsyncResult.\n    """\n    print(a.get())\n\ngevent.joinall([\n    gevent.spawn(setter),\n    gevent.spawn(waiter),\n])\n\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br")])]),e("h2",{attrs:{id:"队列"}},[n._v("队列")]),n._v(" "),e("p",[n._v("队列是一个排序的数据集合，它有常见的"),e("code",[n._v("put")]),n._v(" / "),e("code",[n._v("get")]),n._v("操作， 但是它是以在Greenlet之间可以安全操作的方式来实现的。")]),n._v(" "),e("p",[n._v("举例来说，如果一个Greenlet从队列中取出一项，此项就不会被 同时执行的其它Greenlet再取到了。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport gevent\nfrom gevent.queue import Queue\n\ntasks = Queue()\n\ndef worker(n):\n    while not tasks.empty():\n        task = tasks.get()\n        print('Worker %s got task %s' % (n, task))\n        gevent.sleep(0)\n\n    print('Quitting time!')\n\ndef boss():\n    for i in xrange(1,25):\n        tasks.put_nowait(i)\n\ngevent.spawn(boss).join()\n\ngevent.joinall([\n    gevent.spawn(worker, 'steve'),\n    gevent.spawn(worker, 'john'),\n    gevent.spawn(worker, 'nancy'),\n])\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nWorker steve got task 1\nWorker john got task 2\nWorker nancy got task 3\nWorker steve got task 4\nWorker nancy got task 5\nWorker john got task 6\nWorker steve got task 7\nWorker john got task 8\nWorker nancy got task 9\nWorker steve got task 10\nWorker nancy got task 11\nWorker john got task 12\nWorker steve got task 13\nWorker john got task 14\nWorker nancy got task 15\nWorker steve got task 16\nWorker nancy got task 17\nWorker john got task 18\nWorker steve got task 19\nWorker john got task 20\nWorker nancy got task 21\nWorker steve got task 22\nWorker nancy got task 23\nWorker john got task 24\nQuitting time!\nQuitting time!\nQuitting time!\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br")])]),e("p",[n._v("如果需要，队列也可以阻塞在"),e("code",[n._v("put")]),n._v("或"),e("code",[n._v("get")]),n._v("操作上。")]),n._v(" "),e("p",[e("code",[n._v("put")]),n._v("和"),e("code",[n._v("get")]),n._v("操作都有非阻塞的版本，"),e("code",[n._v("put_nowait")]),n._v("和"),e("code",[n._v("get_nowait")]),n._v("不会阻塞， 然而在操作不能完成时抛出 "),e("code",[n._v("gevent.queue.Empty")]),n._v("或"),e("code",[n._v("gevent.queue.Full")]),n._v("异常。")]),n._v(" "),e("p",[n._v("在下面例子中，我们让boss与多个worker同时运行，并限制了queue不能放入多于3个元素。 这个限制意味着，直到queue有空余空间之间， "),e("code",[n._v("put")]),n._v("操作会被阻塞。相反地，如果队列中 没有元素， "),e("code",[n._v("get")]),n._v("操作会被阻塞。它同时带一个timeout参数，允许在超时时间内如果 队列没有元素无法完成操作就抛出 "),e("code",[n._v("gevent.queue.Empty")]),n._v("异常。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport gevent\nfrom gevent.queue import Queue, Empty\n\ntasks = Queue(maxsize=3)\n\ndef worker(n):\n    try:\n        while True:\n            task = tasks.get(timeout=1) # decrements queue size by 1\n            print('Worker %s got task %s' % (n, task))\n            gevent.sleep(0)\n    except Empty:\n        print('Quitting time!')\n\ndef boss():\n    \"\"\"\n    Boss will wait to hand out work until a individual worker is\n    free since the maxsize of the task queue is 3.\n    \"\"\"\n\n    for i in xrange(1,10):\n        tasks.put(i)\n    print('Assigned all work in iteration 1')\n\n    for i in xrange(10,20):\n        tasks.put(i)\n    print('Assigned all work in iteration 2')\n\ngevent.joinall([\n    gevent.spawn(boss),\n    gevent.spawn(worker, 'steve'),\n    gevent.spawn(worker, 'john'),\n    gevent.spawn(worker, 'bob'),\n])\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br"),e("span",{staticClass:"line-number"},[n._v("32")]),e("br"),e("span",{staticClass:"line-number"},[n._v("33")]),e("br"),e("span",{staticClass:"line-number"},[n._v("34")]),e("br"),e("span",{staticClass:"line-number"},[n._v("35")]),e("br"),e("span",{staticClass:"line-number"},[n._v("36")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nWorker steve got task 1\nWorker john got task 2\nWorker bob got task 3\nWorker steve got task 4\nWorker bob got task 5\nWorker john got task 6\nAssigned all work in iteration 1\nWorker steve got task 7\nWorker john got task 8\nWorker bob got task 9\nWorker steve got task 10\nWorker bob got task 11\nWorker john got task 12\nWorker steve got task 13\nWorker john got task 14\nWorker bob got task 15\nWorker steve got task 16\nWorker bob got task 17\nWorker john got task 18\nAssigned all work in iteration 2\nWorker steve got task 19\nQuitting time!\nQuitting time!\nQuitting time!\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br")])]),e("h2",{attrs:{id:"组和池"}},[n._v("组和池")]),n._v(" "),e("p",[n._v("组(group)是一个运行中greenlet的集合，集合中的greenlet像一个组一样 会被共同管理和调度。 它也兼饰了像Python的"),e("code",[n._v("multiprocessing")]),n._v("库那样的 平行调度器的角色。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport gevent\nfrom gevent.pool import Group\n\ndef talk(msg):\n    for i in xrange(3):\n        print(msg)\n\ng1 = gevent.spawn(talk, 'bar')\ng2 = gevent.spawn(talk, 'foo')\ng3 = gevent.spawn(talk, 'fizz')\n\ngroup = Group()\ngroup.add(g1)\ngroup.add(g2)\ngroup.join()\n\ngroup.add(g3)\ngroup.join()\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nbar\nbar\nbar\nfoo\nfoo\nfoo\nfizz\nfizz\nfizz\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br")])]),e("p",[n._v("在管理异步任务的分组上它是非常有用的。")]),n._v(" "),e("p",[n._v("就像上面所说，"),e("code",[n._v("Group")]),n._v("也以不同的方式为分组greenlet/分发工作和收集它们的结果也提供了API。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport gevent\nfrom gevent import getcurrent\nfrom gevent.pool import Group\n\ngroup = Group()\n\ndef hello_from(n):\n    print('Size of group %s' % len(group))\n    print('Hello from Greenlet %s' % id(getcurrent()))\n\ngroup.map(hello_from, xrange(3))\n\ndef intensive(n):\n    gevent.sleep(3 - n)\n    return 'task', n\n\nprint('Ordered')\n\nogroup = Group()\nfor i in ogroup.imap(intensive, xrange(3)):\n    print(i)\n\nprint('Unordered')\n\nigroup = Group()\nfor i in igroup.imap_unordered(intensive, xrange(3)):\n    print(i)\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nSize of group 3\nHello from Greenlet 31048720\nSize of group 3\nHello from Greenlet 31049200\nSize of group 3\nHello from Greenlet 31049040\nOrdered\n('task', 0)\n('task', 1)\n('task', 2)\nUnordered\n('task', 2)\n('task', 1)\n('task', 0)\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br")])]),e("p",[n._v("池(pool)是一个为处理数量变化并且需要限制并发的greenlet而设计的结构。 在需要并行地做很多受限于网络和IO的任务时常常需要用到它。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport gevent\nfrom gevent.pool import Pool\n\npool = Pool(2)\n\ndef hello_from(n):\n    print('Size of pool %s' % len(pool))\n\npool.map(hello_from, xrange(3))\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nSize of pool 2\nSize of pool 2\nSize of pool 1\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br")])]),e("p",[n._v("当构造gevent驱动的服务时，经常会将围绕一个池结构的整个服务作为中心。 一个例子就是在各个socket上轮询的类。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('from gevent.pool import Pool\n\nclass SocketPool(object):\n\n    def __init__(self):\n        self.pool = Pool(1000)\n        self.pool.start()\n\n    def listen(self, socket):\n        while True:\n            socket.recv()\n\n    def add_handler(self, socket):\n        if self.pool.full():\n            raise Exception("At maximum pool size")\n        else:\n            self.pool.spawn(self.listen, socket)\n\n    def shutdown(self):\n        self.pool.kill()\n\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br")])]),e("h2",{attrs:{id:"锁和信号量"}},[n._v("锁和信号量")]),n._v(" "),e("p",[n._v("信号量是一个允许greenlet相互合作，限制并发访问或运行的低层次的同步原语。 信号量有两个方法， "),e("code",[n._v("acquire")]),n._v("和"),e("code",[n._v("release")]),n._v("。在信号量是否已经被 acquire或release，和拥有资源的数量之间不同，被称为此信号量的范围 (the bound of the semaphore)。如果一个信号量的范围已经降低到0，它会 阻塞acquire操作直到另一个已经获得信号量的greenlet作出释放。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nfrom gevent import sleep\nfrom gevent.pool import Pool\nfrom gevent.coros import BoundedSemaphore\n\nsem = BoundedSemaphore(2)\n\ndef worker1(n):\n    sem.acquire()\n    print('Worker %i acquired semaphore' % n)\n    sleep(0)\n    sem.release()\n    print('Worker %i released semaphore' % n)\n\ndef worker2(n):\n    with sem:\n        print('Worker %i acquired semaphore' % n)\n        sleep(0)\n    print('Worker %i released semaphore' % n)\n\npool = Pool()\npool.map(worker1, xrange(0,2))\npool.map(worker2, xrange(3,6))\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nWorker 0 acquired semaphore\nWorker 1 acquired semaphore\nWorker 0 released semaphore\nWorker 1 released semaphore\nWorker 3 acquired semaphore\nWorker 4 acquired semaphore\nWorker 3 released semaphore\nWorker 4 released semaphore\nWorker 5 acquired semaphore\nWorker 5 released semaphore\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br")])]),e("p",[n._v("范围为1的信号量也称为锁(lock)。它向单个greenlet提供了互斥访问。 信号量和锁常常用来保证资源只在程序上下文被单次使用。")]),n._v(" "),e("h2",{attrs:{id:"线程局部变量"}},[n._v("线程局部变量")]),n._v(" "),e("p",[n._v("Gevent也允许你指定局部于greenlet上下文的数据。 在内部，它被实现为以greenlet的 "),e("code",[n._v("getcurrent()")]),n._v("为键， 在一个私有命名空间寻址的全局查找。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('\nimport gevent\nfrom gevent.local import local\n\nstash = local()\n\ndef f1():\n    stash.x = 1\n    print(stash.x)\n\ndef f2():\n    stash.y = 2\n    print(stash.y)\n\n    try:\n        stash.x\n    except AttributeError:\n        print("x is not local to f2")\n\ng1 = gevent.spawn(f1)\ng2 = gevent.spawn(f2)\n\ngevent.joinall([g1, g2])\n\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n1\n2\nx is not local to f2\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br")])]),e("p",[n._v("很多集成了gevent的web框架将HTTP会话对象以线程局部变量的方式存储在gevent内。 例如使用Werkzeug实用库和它的proxy对象，我们可以创建Flask风格的请求对象。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("from gevent.local import local\nfrom werkzeug.local import LocalProxy\nfrom werkzeug.wrappers import Request\nfrom contextlib import contextmanager\n\nfrom gevent.wsgi import WSGIServer\n\n_requests = local()\nrequest = LocalProxy(lambda: _requests.request)\n\n@contextmanager\ndef sessionmanager(environ):\n    _requests.request = Request(environ)\n    yield\n    _requests.request = None\n\ndef logic():\n    return \"Hello \" + request.remote_addr\n\ndef application(environ, start_response):\n    status = '200 OK'\n\n    with sessionmanager(environ):\n        body = logic()\n\n    headers = [\n        ('Content-Type', 'text/html')\n    ]\n\n    start_response(status, headers)\n    return [body]\n\nWSGIServer(('', 8000), application).serve_forever()\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br"),e("span",{staticClass:"line-number"},[n._v("32")]),e("br"),e("span",{staticClass:"line-number"},[n._v("33")]),e("br"),e("span",{staticClass:"line-number"},[n._v("34")]),e("br")])]),e("p",[n._v("```````` ```````")]),n._v(" "),e("p",[n._v("Flask系统比这个例子复杂一点，然而使用线程局部变量作为局部的会话存储， 这个思想是相同的。")]),n._v(" "),e("h2",{attrs:{id:"子进程"}},[n._v("子进程")]),n._v(" "),e("p",[n._v("自gevent 1.0起，"),e("code",[n._v("gevent.subprocess")]),n._v("，一个Python "),e("code",[n._v("subprocess")]),n._v("模块 的修补版本已经添加。它支持协作式的等待子进程。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nimport gevent\nfrom gevent.subprocess import Popen, PIPE\n\ndef cron():\n    while True:\n        print(\"cron\")\n        gevent.sleep(0.2)\n\ng = gevent.spawn(cron)\nsub = Popen(['sleep 1; uname'], stdout=PIPE, shell=True)\nout, err = sub.communicate()\ng.kill()\nprint(out.rstrip())\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br")])]),e("p",[n._v("`````` ```")]),n._v(" "),e("p",[n._v("cron\ncron\ncron\ncron\ncron\nLinux")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n````` ````\n\n很多人也想将`gevent`和`multiprocessing`一起使用。最明显的挑战之一 就是 `multiprocessing`提供的进程间通信默认不是协作式的。由于基于 `multiprocessing.Connection`的对象(例如`Pipe`)暴露了它们下面的 文件描述符(file descriptor)，`gevent.socket.wait_read`和`wait_write` 可以用来在直接读写之前协作式的等待ready-to-read/ready-to-write事件。\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br")])]),e("p",[n._v("import gevent\nfrom multiprocessing import Process, Pipe\nfrom gevent.socket import wait_read, wait_write")]),n._v(" "),e("h1",{attrs:{id:"to-process"}},[n._v("To Process")]),n._v(" "),e("p",[n._v("a, b = Pipe()")]),n._v(" "),e("h1",{attrs:{id:"from-process"}},[n._v("From Process")]),n._v(" "),e("p",[n._v("c, d = Pipe()")]),n._v(" "),e("p",[n._v('def relay():\nfor i in xrange(10):\nmsg = b.recv()\nc.send(msg + " in " + str(i))')]),n._v(" "),e("p",[n._v("def put_msg():\nfor i in xrange(10):\nwait_write(a.fileno())\na.send('hi')")]),n._v(" "),e("p",[n._v("def get_msg():\nfor i in xrange(10):\nwait_read(d.fileno())\nprint(d.recv())")]),n._v(" "),e("p",[n._v("if "),e("strong",[n._v("name")]),n._v(" == '"),e("strong",[n._v("main")]),n._v("':\nproc = Process(target=relay)\nproc.start()")]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("g1 = gevent.spawn(get_msg)\ng2 = gevent.spawn(put_msg)\ngevent.joinall([g1, g2], timeout=1)\n")])])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n然而要注意，组合`multiprocessing`和gevent必定带来 依赖于操作系统(os-dependent)的缺陷，其中有：\n\n*   在兼容POSIX的系统[创建子进程(forking)](http://linux.die.net/man/2/fork)之后， 在子进程的gevent的状态是不适定的(ill-posed)。一个副作用就是， `multiprocessing.Process`创建之前的greenlet创建动作，会在父进程和子进程两 方都运行。\n\n*   上例的`put_msg()`中的`a.send()`可能依然非协作式地阻塞调用的线程：一个 ready-to-write事件只保证写了一个byte。在尝试写完成之前底下的buffer可能是满的。\n\n*   上面表示的基于`wait_write()`/`wait_read()`的方法在Windows上不工作 ( `IOError: 3 is not a socket (files are not supported)`)，因为Windows不能监视 pipe事件。\n\nPython包[gipc](http://pypi.python.org/pypi/gipc)以大体上透明的方式在 兼容POSIX系统和Windows上克服了这些挑战。它提供了gevent感知的基于 `multiprocessing.Process`的子进程和gevent基于pipe的协作式进程间通信。\n\n## Actors\n\nactor模型是一个由于Erlang变得普及的更高层的并发模型。 简单的说它的主要思想就是许多个独立的Actor，每个Actor有一个可以从 其它Actor接收消息的收件箱。Actor内部的主循环遍历它收到的消息，并 根据它期望的行为来采取行动。\n\nGevent没有原生的Actor类型，但在一个子类化的Greenlet内使用队列， 我们可以定义一个非常简单的。\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br")])]),e("p",[n._v("import gevent\nfrom gevent.queue import Queue")]),n._v(" "),e("p",[n._v("class Actor(gevent.Greenlet):")]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v('def __init__(self):\n    self.inbox = Queue()\n    Greenlet.__init__(self)\n\ndef receive(self, message):\n    """\n    Define in your subclass.\n    """\n    raise NotImplemented()\n\ndef _run(self):\n    self.running = True\n\n    while self.running:\n        message = self.inbox.get()\n        self.receive(message)\n')])])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n下面是一个使用的例子：\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br")])]),e("p",[n._v("import gevent\nfrom gevent.queue import Queue\nfrom gevent import Greenlet")]),n._v(" "),e("p",[n._v("class Pinger(Actor):\ndef receive(self, message):\nprint(message)\npong.inbox.put('ping')\ngevent.sleep(0)")]),n._v(" "),e("p",[n._v("class Ponger(Actor):\ndef receive(self, message):\nprint(message)\nping.inbox.put('pong')\ngevent.sleep(0)")]),n._v(" "),e("p",[n._v("ping = Pinger()\npong = Ponger()")]),n._v(" "),e("p",[n._v("ping.start()\npong.start()")]),n._v(" "),e("p",[n._v("ping.inbox.put('start')\ngevent.joinall([ping, pong])")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n# 真实世界的应用\n\n## Gevent ZeroMQ\n\n[ZeroMQ](http://www.zeromq.org/) 被它的作者描述为 “一个表现得像一个并发框架的socket库”。 它是一个非常强大的，为构建并发和分布式应用的消息传递层。\n\nZeroMQ提供了各种各样的socket原语。最简单的是请求-应答socket对 (Request-Response socket pair)。一个socket有两个方法`send`和`recv`， 两者一般都是阻塞操作。但是 [Travis Cline](https://github.com/traviscline) 的一个杰出的库弥补了这一点，这个库使用gevent.socket来以非阻塞的方式 轮询ZereMQ socket。通过命令：\n\n`pip install gevent-zeromq`\n\n你可以从PyPi安装gevent-zeremq。\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br")])]),e("h1",{attrs:{id:"note-remember-to-pip-install-pyzmq-gevent-zeromq"}},[n._v("Note: Remember to "),e("code",[n._v("pip install pyzmq gevent_zeromq")])]),n._v(" "),e("p",[n._v("import gevent\nfrom gevent_zeromq import zmq")]),n._v(" "),e("h1",{attrs:{id:"global-context"}},[n._v("Global Context")]),n._v(" "),e("p",[n._v("context = zmq.Context()")]),n._v(" "),e("p",[n._v('def server():\nserver_socket = context.socket(zmq.REQ)\nserver_socket.bind("tcp://127.0.0.1:5000")')]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("for request in range(1,10):\n    server_socket.send(\"Hello\")\n    print('Switched to Server for %s' % request)\n    # Implicit context switch occurs here\n    server_socket.recv()\n")])])]),e("p",[n._v('def client():\nclient_socket = context.socket(zmq.REP)\nclient_socket.connect("tcp://127.0.0.1:5000")')]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("for request in range(1,10):\n\n    client_socket.recv()\n    print('Switched to Client for %s' % request)\n    # Implicit context switch occurs here\n    client_socket.send(\"World\")\n")])])]),e("p",[n._v("publisher = gevent.spawn(server)\nclient    = gevent.spawn(client)")]),n._v(" "),e("p",[n._v("gevent.joinall([publisher, client])")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br")])]),e("p",[n._v("Switched to Server for 1\nSwitched to Client for 1\nSwitched to Server for 2\nSwitched to Client for 2\nSwitched to Server for 3\nSwitched to Client for 3\nSwitched to Server for 4\nSwitched to Client for 4\nSwitched to Server for 5\nSwitched to Client for 5\nSwitched to Server for 6\nSwitched to Client for 6\nSwitched to Server for 7\nSwitched to Client for 7\nSwitched to Server for 8\nSwitched to Client for 8\nSwitched to Server for 9\nSwitched to Client for 9")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n## 简单server\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br")])]),e("h1",{attrs:{id:"on-unix-access-with-nc-127-0-0-1-5000"}},[n._v("On Unix: Access with "),e("code",[n._v("$ nc 127.0.0.1 5000")])]),n._v(" "),e("h1",{attrs:{id:"on-window-access-with-telnet-127-0-0-1-5000"}},[n._v("On Window: Access with "),e("code",[n._v("$ telnet 127.0.0.1 5000")])]),n._v(" "),e("p",[n._v("from gevent.server import StreamServer")]),n._v(" "),e("p",[n._v("def handle(socket, address):\nsocket.send(\"Hello from a telnet!\\n\")\nfor i in range(5):\nsocket.send(str(i) + '\\n')\nsocket.close()")]),n._v(" "),e("p",[n._v("server = StreamServer(('127.0.0.1', 5000), handle)\nserver.serve_forever()")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n## WSGI Servers\n\nGevent为HTTP内容服务提供了两种WSGI server。从今以后就称为 `wsgi`和`pywsgi`：\n\n*   gevent.wsgi.WSGIServer\n*   gevent.pywsgi.WSGIServer\n\n在1.0.x之前更早期的版本里，gevent使用libevent而不是libev。 Libevent包含了一个快速HTTP server，它被用在gevent的`wsgi` server。\n\n在gevent 1.0.x版本，没有包括http server了。作为替代，`gevent.wsgi` 现在是纯Python server `gevent.pywsgi`的一个别名。\n\n## 流式server\n\n**这个章节不适用于gevent 1.0.x版本**\n\n熟悉流式HTTP服务(streaming HTTP service)的人知道，它的核心思想 就是在头部(header)不指定内容的长度。反而，我们让连接保持打开， 在每块数据前加一个16进制字节来指示数据块的长度，并将数据刷入pipe中。 当发出一个0长度数据块时，流会被关闭。\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br")])]),e("p",[n._v("HTTP/1.1 200 OK\nContent-Type: text/plain\nTransfer-Encoding: chunked")]),n._v(" "),e("p",[n._v("8\n")]),e("p",[n._v("Hello")]),n._v(" "),e("p",[n._v("9\nWorld")]),e("p"),n._v(" "),e("p",[n._v("0")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n上述的HTTP连接不能在wsgi中创建，因为它不支持流式。 请求只有被缓冲(buffered)下来。\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br")])]),e("p",[n._v("from gevent.wsgi import WSGIServer")]),n._v(" "),e("p",[n._v("def application(environ, start_response):\nstatus = '200 OK'\nbody = '")]),e("p",[n._v("Hello World")]),n._v("'"),e("p"),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("headers = [\n    ('Content-Type', 'text/html')\n]\n\nstart_response(status, headers)\nreturn [body]\n")])])]),e("p",[n._v("WSGIServer(('', 8000), application).serve_forever()")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n然而使用pywsgi我们可以将handler写成generator，并以块的形式yield出结果。\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br")])]),e("p",[n._v("from gevent.pywsgi import WSGIServer")]),n._v(" "),e("p",[n._v("def application(environ, start_response):\nstatus = '200 OK'")]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("headers = [\n    ('Content-Type', 'text/html')\n]\n\nstart_response(status, headers)\nyield \"<p>Hello\"\nyield \"World</p>\"\n")])])]),e("p",[n._v("WSGIServer(('', 8000), application).serve_forever()")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n但无论如何，与其它Python server相比gevent server性能是显胜的。 Libev是得到非常好审查的技术，由它写出的server在大规模上表现优异为人熟知。\n\n为了测试基准，试用Apache Benchmark `ab`或浏览 [Benchmark of Python WSGI Servers](http://nichol.as/benchmark-of-python-web-servers) 来与其它server作对比。\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br")])]),e("p",[n._v("$ ab -n 10000 -c 100 http://127.0.0.1:8000/")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n## Long Polling\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br")])]),e("p",[n._v("import gevent\nfrom gevent.queue import Queue, Empty\nfrom gevent.pywsgi import WSGIServer\nimport simplejson as json")]),n._v(" "),e("p",[n._v("data_source = Queue()")]),n._v(" "),e("p",[n._v("def producer():\nwhile True:\ndata_source.put_nowait('Hello World')\ngevent.sleep(1)")]),n._v(" "),e("p",[n._v("def ajax_endpoint(environ, start_response):\nstatus = '200 OK'\nheaders = [\n('Content-Type', 'application/json')\n]")]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("start_response(status, headers)\n\nwhile True:\n    try:\n        datum = data_source.get(timeout=5)\n        yield json.dumps(datum) + '\\n'\n    except Empty:\n        pass\n")])])]),e("p",[n._v("gevent.spawn(producer)")]),n._v(" "),e("p",[n._v("WSGIServer(('', 8000), ajax_endpoint).serve_forever()")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n## Websockets\n\n运行Websocket的例子需要[gevent-websocket](https://bitbucket.org/Jeffrey/gevent-websocket/src)包。\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br")])]),e("h1",{attrs:{id:"simple-gevent-websocket-server"}},[n._v("Simple gevent-websocket server")]),n._v(" "),e("p",[n._v("import json\nimport random")]),n._v(" "),e("p",[n._v("from gevent import pywsgi, sleep\nfrom geventwebsocket.handler import WebSocketHandler")]),n._v(" "),e("p",[n._v("class WebSocketApp(object):\n'''Send random data to the websocket'''")]),n._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[n._v("def __call__(self, environ, start_response):\n    ws = environ['wsgi.websocket']\n    x = 0\n    while True:\n        data = json.dumps({'x': x, 'y': random.randint(1, 5)})\n        ws.send(data)\n        x += 1\n        sleep(0.5)\n")])])]),e("p",[n._v('server = pywsgi.WSGIServer(("", 10000), WebSocketApp(),\nhandler_class=WebSocketHandler)\nserver.serve_forever()')]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\nHTML Page:\n\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br")])]),e("html",[e("head",[e("title",[n._v("Minimal websocket application")]),n._v(" "),e("script",{attrs:{type:"text/javascript",src:"jquery.min.js"}}),n._v(" "),e("script",{attrs:{type:"text/javascript"}})])])])}),[],!1,null,null,null);s.default=t.exports}}]);